name: Release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as Pre-release'
        required: false
        type: boolean
        default: false

jobs:
  build-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install
        
      - name: Build Frontend
        run: bun run build:ui
        
      - name: Upload Frontend Artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: src/start-renderer/dist
          retention-days: 1
  release:
    needs: build-ui
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            arch: 'mac-arm64'
            artifact_pattern: 'src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg'
            output_name: 'Stream-Gate-macOS-ARM64.dmg'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            arch: 'mac-intel'
            artifact_pattern: 'src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg'
            output_name: 'Stream-Gate-macOS-Intel.dmg'
          - platform: 'ubuntu-22.04'
            args: ''
            arch: 'linux-amd64'
            artifact_pattern: 'src-tauri/target/release/bundle/appimage/*.AppImage'
            output_name: 'Stream-Gate-Linux-x64.AppImage'
            extra_artifact: 'src-tauri/target/release/bundle/deb/*.deb'
            extra_output: 'Stream-Gate-Linux-x64.deb'
          - platform: 'windows-latest'
            args: ''
            arch: 'win'
            artifact_pattern: 'src-tauri/target/release/bundle/nsis/*.exe'
            output_name: 'Stream-Gate-Windows-x64.exe'

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install Dependencies
        run: bun install

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev libjavascriptcoregtk-4.1-dev libssl-dev

      - name: Download Frontend Artifact
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: src/start-renderer/dist

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
           workspaces: 'src-tauri -> target'
           shared-key: "tauri-build"

      # Patch tauri.conf.json to disable beforeBuildCommand since we already have the artifacts
      - name: Disable beforeBuildCommand
        shell: bash
        run: |
          sed 's/"beforeBuildCommand": ".*"/"beforeBuildCommand": ""/' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json

      - name: Download Sidecar Binaries
        shell: bash
        run: |
          if [ "${{ matrix.platform }}" == "macos-latest" ]; then
             bun run scripts/download-binaries.js --platform mac
          elif [ "${{ matrix.platform }}" == "windows-latest" ]; then
             bun run scripts/download-binaries.js --platform win
          else
             bun run scripts/download-binaries.js --platform linux
          fi



      - name: Build Tauri App
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          bun run tauri build ${{ matrix.args }}

      - name: Rename Artifacts
        shell: bash
        run: |
          mkdir -p release_artifacts
          
          # Find and move primary artifact
          # Using find because version number might be in filename
          find ${{ matrix.artifact_pattern }} -maxdepth 1 -name "*.dmg" -o -name "*.AppImage" -o -name "*.exe" | head -n 1 | xargs -I {} mv {} release_artifacts/${{ matrix.output_name }}
          
          # Handle extra artifact (Linux DEB)
          if [ -n "${{ matrix.extra_artifact }}" ]; then
            find ${{ matrix.extra_artifact }} -maxdepth 1 -name "*.deb" | head -n 1 | xargs -I {} mv {} release_artifacts/${{ matrix.extra_output }}
          fi
          
          echo "=== Artifacts to Upload ==="
          ls -lh release_artifacts/

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
          name: Release ${{ github.event.inputs.version || github.ref_name }}
          body: |
            ## üéâ Stream Gate ${{ github.event.inputs.version || github.ref_name }}

            ### üì• Downloads

            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | [Stream-Gate-macOS-ARM64.dmg](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-macOS-ARM64.dmg) |
            | macOS (Intel) | [Stream-Gate-macOS-Intel.dmg](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-macOS-Intel.dmg) |
            | Windows (64-bit) | [Stream-Gate-Windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-Windows-x64.exe) |
            | Linux (AppImage) | [Stream-Gate-Linux-x64.AppImage](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-Linux-x64.AppImage) |
            | Linux (DEB) | [Stream-Gate-Linux-x64.deb](https://github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-Linux-x64.deb) |
            | Android | [SlipNet](https://github.com/anonvector/SlipNet) (Recommended Client) |

            ### ü™û Mirrors

            **GitHub Proxy**
            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | [Stream-Gate-macOS-ARM64.dmg](https://github-mirrors.margrop.net/github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-macOS-ARM64.dmg) |
            | macOS (Intel) | [Stream-Gate-macOS-Intel.dmg](https://github-mirrors.margrop.net/github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-macOS-Intel.dmg) |
            | Windows (64-bit) | [Stream-Gate-Windows-x64.exe](https://github-mirrors.margrop.net/github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-Windows-x64.exe) |
            | Linux (AppImage) | [Stream-Gate-Linux-x64.AppImage](https://github-mirrors.margrop.net/github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-Linux-x64.AppImage) |
            | Linux (DEB) | [Stream-Gate-Linux-x64.deb](https://github-mirrors.margrop.net/github.com/${{ github.repository }}/releases/download/${{ github.event.inputs.version || github.ref_name }}/Stream-Gate-Linux-x64.deb) |
            
            ### ‚ú® What's New

            See the [changelog](https://github.com/${{ github.repository }}/compare/${{ github.event.inputs.version || github.ref_name }}...main) for details.
            
            ### üöÄ Quick Start
            
            1. Download the installer for your platform
            2. Install the application
            3. Launch Stream Gate
            4. Click "Connect"
            
            ### üìñ Documentation

            For setup instructions and troubleshooting, see the [README](https://github.com/${{ github.repository }}#readme).
            
            ---
            
            <div align="center">
              <strong>Made with ‚ù§Ô∏è for the future of open internet.</strong>
            </div>

          files: |
            release_artifacts/*
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' || contains(github.ref, '-') }}
